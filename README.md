# Дорогой ревьювер, боюсь, у меня нет времени на отплоировку проекта в связи с деделайном =(

# Kittygram, контейнеры, CI/CD, Terraform

Проект разбит на два контура, инфраструктура в Яндекс Облаке и деплой приложения на ВМ через Docker и GitHub Actions.

## Состав репозитория

В корне присутствуют файлы и каталоги по требованию задания. .env.example, README.md, .github/workflows/terraform.yml, .github/workflows/deploy.yml, директория infra с Terraform-конфигурацией, backend с Django-приложением, docker-compose.production.yml, frontend с готовым Dockerfile, kittygram_workflow.yml, nginx с Dockerfile и конфигурацией, pytest.ini, tests.yml, tests.

## Что сделано по инфраструктуре

Создана Terraform-конфигурация в каталоге infra. Включены файлы версий и провайдера, переменные, основной модуль, backend для хранения состояния, outputs. Провайдер yandex сконфигурирован на cloud_id и folder_id, авторизация через ключ сервисного аккаунта с диска. Для хранения Terraform state используется Object Storage S3, backend инициализируется из workflow с параметрами бакета, ключа состояния, конечной точки и региона совместимости. Создаются VPC-сеть, подсеть, группа безопасности. В группе безопасности открыт входящий трафик на 22 и 80, исходящий разрешен. Создается виртуальная машина в требуемой зоне. Через cloud-init производится подготовка окружения, установка Docker, добавление пользователя в группу docker, подготовка каталога для деплоя.

## Что сделано по приложению и контейнерам

Backend переведен на PostgreSQL через переменные окружения. SECRET_KEY берется из окружения. Генерация ключа учтена на стадии подготовки env. В nginx настроено проксирование для /api и /admin на backend с Gunicorn, раздача статики и медиа через общие volumes. В compose описаны четыре сервиса, база postgres, backend, frontend, gateway. Применены три volumes, pg_data, static, media. Frontend билдит статические файлы и выкладывает их в общий volume для раздачи через gateway, контейнер фронтенда остается живым после копирования. Бэкенд подключен к БД, завязан на готовность postgres через healthcheck. Порт 80 опубликован со стороны gateway.

## CI/CD деплоя

В deploy.yml реализован конвейер. Проверка кода бэкенда на PEP8, запуск автотестов бэкенда и фронтенда. Сборка трех образов проекта и загрузка на Docker Hub с фиксированной платформой. Деплой на удаленную ВМ по SSH. На ВМ кладутся .env и docker-compose.production.yml, выполняется перезапуск контейнеров, запуск миграций и сборка статики. После деплоя выполняются смоук-тесты. Оповещение в Telegram предусмотрено переменными, выполняется при наличии токена и адресата.

Требуемые секреты репозитория для деплоя настроены. Доступ к Docker Hub, доступ по SSH, параметры оповещения Telegram.

## CI Terraform

terraform.yml запускается вручную, доступные операции plan, apply, destroy через входной параметр. Ключ сервисного аккаунта ЯО хранится в секрете в виде сырого JSON и пишется в файл перед шагами Terraform. Инициализация backend S3 выполняется из workflow, bucket, key, endpoint, совместимый регион, стиль путей, учетные данные доступа к Object Storage. Переменные TF_VAR прокидываются в plan, apply, destroy, включая путь к файлу ключа сервисного аккаунта, идентификаторы облака и каталога, SSH-параметры для метадаты ВМ.

Требуемые секреты репозитория для terraform.yml настроены. Ключи доступа к Object Storage, имя бакета для состояния, идентификаторы cloud и folder, сырой JSON ключ сервисного аккаунта, SSH-параметры.

## .env.example

Содержит переменные для БД и Django. Пользователь и пароль для postgres, имя БД, параметры подключения к БД, DEBUG выключен, ALLOWED_HOSTS с IP ВМ и локальными адресами, параметры email бэкенда, SECRET_KEY как заглушка. На продакшене файл формируется на этапе деплоя.

## tests.yml

Заполнен по формату проверки. Логин владельца репозитория, домен проекта на ВМ в виде http со ссылкой на gateway, логин Docker Hub.

## Соответствие чеклисту

Инфраструктура описана Terraform, применяются сеть, подсеть, security group и ВМ. Хранение состояния вынесено в S3. Cloud-init готовит окружение ВМ. Приложение контейнеризовано и деплоится через GitHub Actions. Nginx проксирует API и админку, раздает статику и медиа. БД PostgreSQL подключена через переменные окружения. Автотесты и линтинг запускаются. Образы собираются и публикуются. После деплоя миграции и сборка статики выполняются. Оповещение в Telegram предусмотрено.

## Известные ограничения

Совместимость backend S3 Terraform с Object Storage требует явной конфигурации endpoint и региона совместимости из workflow. Для секретов GitHub Actions критична форма хранения ключа сервисного аккаунта, используется сырое JSON-содержимое как секрет. Для корректной работы фронта и статики контейнер фронтенда должен оставаться запущенным после копирования артефактов. В .env для продакшена должен быть указан корректный список ALLOWED_HOSTS с IP ВМ.
